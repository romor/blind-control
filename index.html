<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="blind-control : Automatically control sun blinds depending on sun radiation and temperature using a Somfy RTS remote control and a Raspberry Pi." />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>blind-control</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/romor/blind-control">View on GitHub</a>

          <h1 id="project_title">blind-control</h1>
          <h2 id="project_tagline">Automatically control motorized blinds depending on sun radiation and temperature using a Somfy RTS remote control and a Raspberry Pi.</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/romor/blind-control/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/romor/blind-control/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a name="project-target" class="anchor" href="#project-target"><span class="octicon octicon-link"></span></a>Project Target</h1>

<p>This project is about electrically controlled roller shutters and motorized blinds. These are controlled with the Somfy RTS RF remote control system. In summer time, I like to automatically control the blinds such that they close if significant sun light would come insight and open again if direct sun light is over again.
Since the blinds are located at different angles on different sides of the house I need individual control of the blinds, depending on their position.
Also I want to maximize the opening time to have it as bright as possible insight. However, if the sun shines directly into a window the blind must be down to avoid overheating of the house.
As a result, each blind shall only close if the sun has an angle for direct radiation. Further more, the blind should also not close if the sky is cloudy and no direct sun light prevails.</p>

<h1>
<a name="possible-solutions" class="anchor" href="#possible-solutions"><span class="octicon octicon-link"></span></a>Possible solutions</h1>

<p>How to control the blinds
The following alternatives were considered by me:


<h3>1. Use Somfy Timer Unit</h3>
<p>Somfy offers a timer control for their systems such as Chronis Comfort RTS Timer. You can program a specific time for opening and closing of the blinds. This time can also depend on sunrise and sunset. But this is limited to +/- 1 hour around sunrise and sunset and therefore only hardly suitable.</p>
<p><img src="images/somfy_chronis.png" alt="Chronis Comfort RTS Timer"></p>

<p><strong>Advantages</strong></p>

<ul>
<li>easy to implement: just by the unit and program it</li>
</ul><p><strong>Disadvantages</strong></p>

<ul>
<li>only 1 channel per timer, which means that I need several units for individual control of the blinds</li>
<li>not possible to automatically change control based on cloudy weather condition or temperatures</li>
<li>not possible to automatically adapt it to changing sun position</li>
</ul>


<h3>2. Somfy Universial RTS Interface</h3>
<p>Somfy offers a universal interface, which provides a RS485 communication interface. It is able to serve multiple channels so each blind could be controlled individually.</p>
<p><img src="images/somfy_rs485.png" alt="Somfy Universal Interface"></p>

<p><strong>Advantages</strong></p>

<ul>
<li>available HW unit, only software development necessary</li>
<li>full flexibility with regard to automation</li>
</ul><p><strong>Disadvantages</strong></p>

<ul>
<li>from my perspective the interface is much too expensive. It seems that Somfy wants to inhibit such applications. Also on the product description Somfy mentions that there is no support for this interface product at all.</li>
<li>the serial interface seems outdated to me. I prefer an ethernet connection such that I do not need a computer locally attached and running 24 hours per day.</li>
</ul>


<h3>3. Build my own Interface</h3>
<p>The Somfy Telis 4 RTS is available for reasonable budget and offers 5 channels. If the button contact can be closed by some software controlled unit with ethernet interface I have all I need. This can easily be done using a Raspberry Pi.</p>
<p><img src="images/somfy_telis_4.png" alt="Somfy Telis 4"> <img src="images/raspberry_pi.jpg" alt="Raspberry Pi"></p>

<p><strong>Advantages</strong></p>
<ul>
<li>full flexibility</li>
<li>low price</li>
</ul>

<p><strong>Disadvantages</strong></p>
<ul>
<li>more development effort needed, including hardware adaptations</li>
</ul>

<p>I chose to go for solution 3, which I will outline in more detail below.</p>



<h1>
<a name="hardware-setup" class="anchor" href="#hardware-setup"><span class="octicon octicon-link"></span></a>Hardware Setup</h1>

<p>The Somfy Telis 5 RTS provides the interface to the radio signal. I use this unit as it is and just solder wires to the button lines to control them automatically. The buttons seem to be connected to pull up resistors and close contact to ground if pressed. Therefore, I soldered wires to each button and the GND connection:</p>
<p><img src="images/soldering_2.jpg" alt="soldered wires on Somfy Telis"></p>

<p>These wires are connected to the GPIO interface of a Raspberry Pi. To simulate a button press, the GPIO pin of the RPi is set to zero, to release the button again the GPIO pin is set to high impedance state (thus reconfigured as input).</p>

<p>As a result, the wiring is like this:</p>

<ul>
<li>Telis Buttons &lt;-&gt; RPi GPIOs</li>
<li>...</li>
<li>Telis Battery - &lt;-&gt; RPi GND</li>
<li>Telis Battery + &lt;-&gt; RPi 3.3 V</li>
</ul>
<p>Refer to the Excel sheet in the git <a href="https://github.com/romor/blind-control/tree/master/doc">documentation directory</a> for concrete pin numbering.</p>

<p>Notice that the Somfy Telis remote is powered by the Raspberry Pi. Its battery is removed and the contacts are connected to the 3.3 V supply of the RPi. There are 2 good places to put the supply wires on, with holes where they can easily be soldered.<p>

<p>The total setup including the Raspberry Pi is shown here:</p>
<p><img src="images/assembly.jpg" alt="Somfy Telis assembled to Raspberry Pi"></p>

<p>Finally I attached 2 Telis remotes to increase the number of contrallable channels to 10. The RPi provides enough GPIOs such that you could also operate 3 remotes.</p>

<p>For your reference: I found a similar approach in the OpenRemote project in this article:<br>
<a href="http://www.openremote.org/display/docs/OpenRemote+2.0+How+To+-+Control+Sunshades+-+Somfy+with+Raspberry+Pi">How To - Control Sunshades - Somfy-Telis with Raspberry Pi</a></p>

<p>This project uses an opto coupler, which is connected between the Telis remote and the Raspberry Pi. I do not see a reason for this as the RPi uses the same voltage range as the Telis remote and a galvanic separation does not seem necessary to me. This simplifies my hardware setup such that no component is needed beside the RPi and the Somfy Telis remote. Also, you do not need to worry about the remote's battery anymore since this is removed and supplied by the Raspberry Pi, too.</p>


<h1>
<a name="software" class="anchor" href="#software"><span class="octicon octicon-link"></span></a>Software</h1>

<p>The software is developed in Python and consists of several independent software components, which are outlined below.</p>

<h2>
<a name="weather-data-retrieval" class="anchor" href="#weather-data-retrieval"><span class="octicon octicon-link"></span></a>Weather Data Retrieval</h2>

<p>This component determines the outside temperature and the probability of sun shine in near future. You need some weather service to provide this data. Normally you should be able to find some public web side to access for current temperature and sun minutes per hour at your location. I was lucky and my local meteorological institute offered me also forecast data, which I receive regularly in CSV format per email.</p>

<p>Thus I developed a Python script that retrieves the email from my personal email account and parses the weather data. The extracted sun shine probability and the outside temperature is then stored to an OPC server.
This storage to an OPC XML-DA server is mainly caused by historical reason because I have such system available (Loytec LINX 120). Additionally it is also stored to a file so you do not need the extra HW to run the system.
Look at the <a href="https://github.com/romor/blind-control/tree/master/blindctrl/zamg">zamg component</a> in the git repository for this functionality.</p>

<h2>
<a name="sun-power-calculation" class="anchor" href="#sun-power-calculation"><span class="octicon octicon-link"></span></a>Window Power Calculation</h2>

<p>This component derives the power of the sun as perceived for each individual window. It derives the current position of the sun on horizon (azimuth, altitude) and the angle of the sun light to each window. Based on this angle it derives the effective sun power for each window. Again, this is stored using an OPC datapoint and additionally into a file.
Look at the <a href="https://github.com/romor/blind-control/tree/master/blindctrl/sunpower">sunpower component</a> in the git repository for this functionality.</p>

<h2>
<a name="command-control" class="anchor" href="#command-control"><span class="octicon octicon-link"></span></a>Command Control</h2>

<p>This <a href="https://github.com/romor/blind-control/tree/master/blindctrl/commander">component</a> derives the up and down commands for the blinds. It compares the sun power from weather service and the effective radiation angle from each window with threshold parameters. If the threshold is reached the desired state of the window is set to closed.</p>

<h2>
<a name="remote-control-driver" class="anchor" href="#remote-control-driver"><span class="octicon octicon-link"></span></a>Remote Control Driver</h2>

<p>This component reads the desired switching status from the OPC data point or file storage and compares it with the current status, which is read from a file. If the status differs it triggers the command on the Telis remote. For this it needs to switch to the corresponding RF channel and issue the open or close command afterwards. Finally it switches the RF channel back to channel 0. The driver also makes sure that all blinds are operated sequentially even if the status changes simultanuous. This is necessary because the single Telis remote control can just operate on the currently selected channel.</p>
<p>Multiple commands on the same remote are scheduled in ordered sequence to optimize channel switching delays. If multiple remotes are used they are handled in different concurrent threads such that also this timing gets optimized. The <a href="https://github.com/romor/blind-control/tree/master/blindctrl/remote">remote component</a> in the git repository covers this functionality.</p>

      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
	  <p class="copyright">Copyright (C) 2014, <a href="https://github.com/romor">Roman Morawek</a><br>
      <a href="http://romor.github.io/blind-control">http://romor.github.io/blind-control</a><br>
      <a href="https://github.com/romor/blind-control">https://github.com/romor/blind-control</a><br>
      License: <a href="http://www.gnu.org/licenses/gpl.html">GNU General Public License, Version 3</a></p>
      </footer>
    </div>

    

  </body>
</html>
